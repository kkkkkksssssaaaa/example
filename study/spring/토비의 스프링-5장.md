# [spring] 🍃 토비의 스프링

---

## 5장. 서비스 추상화

### 5.1 사용자 레벨 관리 기능 추가

- `깔끔한 코드를 추구하기`
    - 코드에 중복된 부분은 없는지
    - 코드가 무엇을 하는 것인지 이해하기에 불편하지는 않는지
    - 코드가 자신이 있어야 할 자리에 있는지
    - 추후 변경이 일어난다면 어떤 부분에서 변경이 일어날지, 변경하기 쉽게 작성 되어 있는지
- 객체지향적 코드는 다른 오브젝트의 데이터를 가져와 작업 하는 대신, 데이터를 갖고이ㅣㅆ는 다른 오브젝트에게 작업을 요청

### 5.2 트랜잭션 서비스 추상화

- `트랜잭션` 이란 더 이상 나눌 수 없는 단위 작업
    - 중간에 예외가 발생해서 작업을 완료할 수 없다면, 작엽이 시작되지 않은 것처럼  초기로 돌려놔야 하는데, 이 것이 바로 트랜잭션
    - e.g. 은행의 계좌 이체 작업은 반드시 하나의 트랜잭션에서 일어나야 함
        - 이체 시 출금 계좌의 잔고는 이체 금액만큼 줄어들고, 입금 계좌는 이체 금액만큼 증가 되야 함
        - 이 때 이체 프로그램에 db 에 두 번의 요청을 보냄
        - 이 두 번의 요청이 하나의 트랜잭션으로 묶여야 함
- 트랜잭션을 시작하는 방법은 한 가지 이지만, 끝나는 방법은 두 가지
    - 트랜잭션 중 예외가 발생하여 작업을 취소 하는 것을 `트랜잭션 롤백` 이라고 함
    - 반대로 트랜잭션이 성공되는 것을 `트랜잭션 커밋` 이라고 함
- 애플리케이션 내 트랜잭션이 시작되고 끝나는 위치를 `트랜잭션 경계` 라고 하며 그 위치를 지정하는 것을 `트랜잭션 경계 설정` 이라고 함
- JDBC 는 하나의 Connection 을 가져와 닫는 사이에 일어난 모든 일을 트랜잭션 경계로 지정
    - 이처럼 하나의 db Connection 에서 이뤄지는 트랜잭션을 `로컬 트랜잭션` 이라고 함
    - 반대로 별도의 트랜잭션 관리자를 통해 이뤄지는 트랜잭션을 `글로벌 트랜잭션` 이 있음
- 트랜잭션 경계 설정은 결국 쿼리 실행 메서드를 호출하는 서비스 로직에서 지정해야 할 것
    - 지금 서비스 코드가 사용자 등급 확인→사용자 등급 업글 호출로 이뤄짐
    - 극단적인 예시로는 서비스 로직에서 Connection 객체를 초기화&종료, 이 객체를 DAO 메서드에게 매개변수로 전달하는 구조가 될 수 있음
    - 같은 Connection 에서 일어난 쿼리를 한 트랜잭션으로 설정하기 때문
- 다행히 위와 같은 방법은 사용하지 않아도 되고, 스프링에서는 `트랜잭션 동기화` 라는 것을 제공함
    - 서비스에서 Connection 을 생성하면 이를 저장할 수 있는 저장소에 보관하고 이후 호출되는 DAO 메서드의 쿼리가 이 Connection 을 사용 하는 것
    - 트랜잭션 종료 시 동기화를 마치는 방식
- 트랜잭션 동기화 저장소는 스레드마다 독립적으로 관리 하기 때문에 다중 사용자의 요청을 처리해야하는 멀티 스레드 환경에서도 충돌 날 염려는 없음
- 스프링 빈으로 등록 할 때 가장 주의해야 할 점은 싱글톤으로 만들어져 여러 스레드에서 동시에 사용해도 괜찮은가 하는 점

### 5.3 서비스 추상화와 단일 책임 원칙

- DI 의 가치는 관심, 책임, 성격이 다른 코드를 깔끔하게 분리 하는 데에 있음
- `단일 책임 원칙`
    - 하나의 모듈은 하나의 책임만 져야 함
    - 하나의 모듈이 바뀌는 이유는 한 가지 이유만 있어야 함

### 5.4 메일 서비스 추상화

- 사용자의 등급 업그레이드 후 메일로 안내 시 메일 발송 코드도 트랜잭션에 포함 되어야 함
- 작은 기능이라도 다른 오브젝트의 기능을 사용하면 사용하는 오브젝트의 기능이 바뀌었을 때 자신이 영향을 받을 수 있기 때문에 의존하고 있다고 하는것
    - 의존 오브젝트를 `협력 오브젝트` 고도 함
- 테스트 대상이 되는 오브젝트의 기능만 수행할 수 있도록 사용하는 오브젝트를 통틀어 `Test Double(테스트 대역)` 이라고 함
    - 대표적인 테스트 대역에는 `Test Stub(테스트 스텁)` 이 있음
    - 테스트 대상 오브젝트의 의존 객체로 존재하면서 테스트 동안에는 코드가 정상적으로 수행할 수 있도록 돕는 것
- 테스트는 보통 어떤 시스템에 입력을 주었을 때 기대하는 출력이 나오는지 검증 하는 것
- 스텁을 이용하면 간접적인 입력 값을 주어 간접적인 출력 값을 받게 할 수 있음
    - 이 경우 간접적인 입출력 값을 검증하며 테스트 대상 오브젝트와 의존 오브젝트 사이에서 알어나는 일을 검증할 수 있도록 설계된 `Mock Object(목 오브젝트)` 를 사용
    - 테스트 오브젝트를 정상적으로 실행되도록 도와주면서 테스트 오브젝트와 자신 사이에 일어나는 커뮤니케이션 내용을 저장해뒀다가 테스트결과를 검증하는 데 활용
    - 서비스 기능 테스트에만 목적을 둔다면 목 오브젝트를 사용하여 테스트 기능과 목 오브젝트간의 커뮤니케이션이 일어났는지에 대해서만 검증해도 괜찮음
- 테스트를 편리하게 할 수 있다는 것 만으로도 서비스 추상화의 가치는 충분함